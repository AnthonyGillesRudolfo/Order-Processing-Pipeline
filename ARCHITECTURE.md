<!-- GENERATED BY AugmentCode -->

# Order Processing Pipeline - Restate Architecture

## Overview

This application demonstrates a complete order processing pipeline built with Restate using **Workflows** and **Virtual Objects** in Go.

## Service Architecture

### 1. **OrderService - WORKFLOW**

The OrderService is implemented as a **Restate Workflow**, which provides:
- **Exactly-once execution** per workflow ID (order ID)
- **Durable state** that persists across restarts
- **Multi-step orchestration** with automatic recovery
- **Workflow key**: Order ID

#### Handlers:
- `CreateOrder` (WorkflowContext) - Main workflow handler that orchestrates the entire order process
- `GetOrder` (WorkflowSharedContext) - Read-only handler to retrieve order details
- `UpdateOrderStatus` (WorkflowContext) - Updates order status in workflow state

#### Workflow Steps:
1. Store order details in workflow state
2. Calculate total amount from items
3. Call Payment Virtual Object to process payment
4. Call Shipping Virtual Object to create shipment
5. Mark order as completed

#### State Stored:
- `customer_id`: Customer identifier
- `status`: Order status (PENDING → PAID → SHIPPED → COMPLETED)
- `total_amount`: Total order amount
- `payment_id`: Payment transaction ID
- `shipment_id`: Shipment ID
- `tracking_number`: Shipping tracking number

### 2. **PaymentService - VIRTUAL OBJECT**

The PaymentService is implemented as a **Restate Virtual Object**, which provides:
- **Stateful processing** keyed by payment ID
- **Single-writer consistency** per payment ID
- **Built-in K/V state** for payment data
- **Idempotent operations** - returns existing status if already processed

#### Handlers:
- `ProcessPayment` (ObjectContext) - Processes payment with durable execution

#### State Stored:
- `status`: Payment status (PAYMENT_PENDING → PAYMENT_COMPLETED/PAYMENT_FAILED)
- `order_id`: Associated order ID
- `amount`: Payment amount

#### Features:
- Checks if payment already processed (idempotency)
- Durable execution for payment transaction
- Stores payment state for audit trail

### 3. **ShippingService - VIRTUAL OBJECT**

The ShippingService is implemented as a **Restate Virtual Object**, which provides:
- **Stateful tracking** keyed by shipment ID
- **Single-writer consistency** per shipment ID
- **Built-in K/V state** for shipment data
- **Read-only tracking** via shared handler

#### Handlers:
- `CreateShipment` (ObjectContext) - Creates shipment with durable execution
- `TrackShipment` (ObjectSharedContext) - Read-only handler for tracking

#### State Stored:
- `status`: Shipment status (SHIPMENT_CREATED → SHIPMENT_IN_TRANSIT → SHIPMENT_DELIVERED)
- `order_id`: Associated order ID
- `tracking_number`: Tracking number
- `estimated_delivery`: Estimated delivery date
- `current_location`: Current shipment location

#### Features:
- Checks if shipment already exists (idempotency)
- Generates unique tracking number
- Durable execution for shipment creation
- Read-only tracking endpoint

## Key Restate Concepts Used

### Workflows
- **Exactly-once execution** per workflow ID
- **Durable state** using `restate.Set()` and `restate.Get()`
- **Service-to-service calls** using `restate.Object()` client
- **Workflow key** accessed via `restate.Key(ctx)`
- **WorkflowContext** for write operations
- **WorkflowSharedContext** for read-only operations

### Virtual Objects
- **Keyed by unique identifier** (payment ID, shipment ID)
- **Single-writer consistency** per key
- **Built-in K/V state** using `restate.Set()` and `restate.Get()`
- **ObjectContext** for write operations
- **ObjectSharedContext** for read-only operations
- **Idempotent operations** by checking existing state

### Durable Execution
- **`restate.Run()`** for durable side effects
- Automatic retry on failures
- Journal-based execution tracking

## Data Flow

```
Client
  │
  ├─> CreateOrder (Workflow)
  │     │
  │     ├─> Store order state
  │     │
  │     ├─> ProcessPayment (Virtual Object)
  │     │     └─> Store payment state
  │     │
  │     ├─> CreateShipment (Virtual Object)
  │     │     └─> Store shipment state
  │     │
  │     └─> Update order status to COMPLETED
  │
  ├─> GetOrder (Workflow - read-only)
  │     └─> Retrieve order state
  │
  └─> TrackShipment (Virtual Object - read-only)
        └─> Retrieve shipment state
```

## Running the Application

### 1. Build
```bash
go build -o order-processing-pipeline .
```

### 2. Start the Server
```bash
./order-processing-pipeline
```

The server will start on port 9080.

### 3. Register with Restate
```bash
restate deployments register http://localhost:9080
```

### 4. Invoke the Workflow
```bash
# Create an order (workflow ID = order-123)
restate workflow start order.sv1.OrderService/order-123 CreateOrder \
  --input '{"customer_id": "customer-456", "items": [{"product_id": "prod-1", "quantity": 2}]}'

# Get order status
restate workflow get order.sv1.OrderService/order-123 GetOrder \
  --input '{"order_id": "order-123"}'

# Track shipment (virtual object key = shipment-789)
restate object call order.sv1.ShippingService/shipment-789 TrackShipment \
  --input '{"shipment_id": "shipment-789"}'
```

## Benefits of This Architecture

1. **Reliability**: Workflows ensure exactly-once execution even with failures
2. **Consistency**: Virtual Objects provide single-writer consistency per key
3. **Observability**: All state changes are tracked in Restate's journal
4. **Scalability**: Virtual Objects can be distributed across multiple instances
5. **Simplicity**: No need for external databases or message queues
6. **Idempotency**: Built-in idempotency for all operations
7. **Durability**: State persists across restarts and failures

## Next Steps

- Implement actual payment gateway integration in `ProcessPayment`
- Implement actual shipping provider API in `CreateShipment`
- Add database persistence for order history
- Add more workflow handlers (CancelOrder, RefundOrder)
- Add more virtual object handlers (UpdateShipmentLocation, AddShipmentEvent)
- Add comprehensive error handling and validation
- Add unit tests using Restate's testing utilities

